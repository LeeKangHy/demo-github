#/usr/bin/env python3

from Crypto.Util.number import long_to_bytes, inverse

# --- 1. Tham số đầu vào ---

# Khóa của tôi
my_private_key_tuple = (21711308225346315542706844618441565741046498277716979943478360598053144971379956916575370343448988601905854572029635846626259487297950305231661109855854947494209135205589258643517961521594924368498672064293208230802441077390193682958095111922082677813175804775628884377724377647428385841831277059274172982280545237765559969228707506857561215268491024097063920337721783673060530181637161577401589126558556182546896783307370517275046522704047385786111489447064794210010802761708615907245523492585896286374996088089317826162798278528296206977900274431829829206103227171839270887476436899494428371323874689055690729986771, 2734411677251148030723138005716109733838866545375527602018255159319631026653190783670493107936401603981429171880504360560494771017246468702902647370954220312452541342858747590576273775107870450853533717116684326976263006435733382045807971890762018747729574021057430331778033982359184838159747331236538501849965329264774927607570410347019418407451937875684373454982306923178403161216817237890962651214718831954215200637651103907209347900857824722653217179548148145687181377220544864521808230122730967452981435355334932104265488075777638608041325256776275200067541533022527964743478554948792578057708522350812154888097)

N = my_private_key_tuple[0]
d_my_key = my_private_key_tuple[1]
e_my_key = 0x10001 # 65537

# Khóa của bạn bè
friend_keys = [
    (N, 106979), 
    (N, 108533), 
    (N, 69557), 
    (N, 97117), 
    (N, 103231)
]

# Bản mã cuối cùng
C_final = 20304610279578186738172766224224793119885071262464464448863461184092225736054747976985179673905441502689126216282897704508745403799054734121583968853999791604281615154100736259131453424385364324630229671185343778172807262640709301838274824603101692485662726226902121105591137437331463201881264245562214012160875177167442010952439360623396658974413900469093836794752270399520074596329058725874834082188697377597949405779039139194196065364426213208345461407030771089787529200057105746584493554722790592530472869581310117300343461207750821737840042745530876391793484035024644475535353227851321505537398888106855012746117

# --- 2. Tính phi(N) ---
# Giả sử k=1, vì e * d_my_key - 1 phải là bội số của phi(N) và e=65537
phi = e_my_key * d_my_key - 1

# Kiểm tra xác nhận: N và phi(N) có rất gần nhau không?
print(f"Modulus N bit length: {N.bit_length()}")
print(f"phi(N) bit length: {phi.bit_length()}")
if N.bit_length() != phi.bit_length():
    # Trường hợp hiếm khi k != 1, chúng ta cần tìm k.
    # Tuy nhiên, trong các bài CTF/luyện tập, k=1 là tiêu chuẩn.
    print("WARNING: N and phi(N) bit lengths differ, check k.")


# --- 3. Tính E_total ---
E_total = 1
for _, e_friend in friend_keys:
    E_total *= e_friend

print("-" * 50)
print(f"Total Public Exponent E_total: {E_total}")


# --- 4. Tính D_total ---
try:
    D_total = inverse(E_total, phi)
    print(f"Total Private Exponent D_total calculated.")
except ValueError:
    print("Error: E_total is not invertible modulo phi(N).")
    exit(1)


# --- 5. Giải mã ---
print("-" * 50)
print("Decrypting...")
# Giải mã: M = C_final ^ D_total mod N
M_int = pow(C_final, D_total, N)

# Chuyển đổi số nguyên M_int thành bytes (flag)
FLAG = long_to_bytes(M_int)

print("-" * 50)
print(f"Giá trị Plaintext (số nguyên): {M_int}")
print(f"Flag đã giải mã: {FLAG.decode('utf-8')}")


"""
OUTPUT :
Modulus N bit length: 2048
phi(N) bit length: 2061
WARNING: N and phi(N) bit lengths differ, check k.
--------------------------------------------------
Total Public Exponent E_total: 8096672573182190344881473
Total Private Exponent D_total calculated.
--------------------------------------------------
Decrypting...
--------------------------------------------------
Giá trị Plaintext (số nguyên): 282351761401118367933191045054313718055580073791559536506841118001604417533527376824087507263144353230054685686578866914410695559969149
Flag đã giải mã: crypto{3ncrypt_y0ur_s3cr3t_w1th_y0ur_fr1end5_publ1c_k3y}

"""